<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Users (Admin)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/users.html">Admin Panel</a>
        <div class="d-flex">
            <button onclick="logout()" class="btn btn-danger">Logout</button>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-2">
            <div class="d-grid gap-2">
                <a class="btn btn-primary" href="/users.html">Admin Panel</a>
                <a class="btn btn-outline-primary" href="/user-home.html">User Home</a>
            </div>
        </div>

        <div class="col-md-10">
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="showUsersList()">Users</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showAddUserForm()">Add User</a>
                </li>
            </ul>

            <div id="errorMessage" class="alert alert-danger d-none"></div>
            <div id="successMessage" class="alert alert-success d-none"></div>

            <!-- Users List -->
            <div id="usersList">
                <div class="card">
                    <div class="card-body p-0">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>First name</th>
                                <th>Last name</th>
                                <th>Age</th>
                                <th>Email</th>
                                <th>Roles</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                            </thead>
                            <tbody id="usersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add/Edit User Form -->
            <div id="userForm" style="display:none;">
                <div class="card">
                    <div class="card-body">
                        <div class="row justify-content-center">
                            <div class="col-md-8 col-lg-6">
                                <h4 id="formTitle">Add User</h4>
                                <form id="addEditUserForm">
                                    <input type="hidden" id="userId">

                                    <div class="mb-3">
                                        <label class="form-label">First name:</label>
                                        <input type="text" id="firstName" class="form-control" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Last name:</label>
                                        <input type="text" id="lastName" class="form-control" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Age:</label>
                                        <input type="number" id="age" class="form-control" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Email:</label>
                                        <input type="email" id="email" class="form-control" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Password:</label>
                                        <input type="password" id="userPassword" class="form-control">
                                        <small class="form-text text-muted" id="passwordHint" style="display:none;">
                                            Leave blank to keep current password
                                        </small>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Role:</label>
                                        <select id="roleName" class="form-select" required>
                                            <option value="ROLE_USER">User</option>
                                            <option value="ROLE_ADMIN">Admin</option>
                                        </select>
                                    </div>

                                    <button type="submit" class="btn btn-success">Save</button>
                                    <button type="button" class="btn btn-secondary" onclick="showUsersList()">Cancel</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const authToken = localStorage.getItem('authToken');

    if (!authToken) {
        window.location.href = '/login.html';
    }

    async function loadUsers() {
        try {
            const response = await fetch('/api/users');
            if (response.ok) {
                const users = await response.json();
                displayUsers(users);
            }
        } catch (error) {
            showError('Error loading users: ' + error.message);
        }
    }

    function displayUsers(users) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = users.map(user => {
            const roles = user.roles.map(r => '[' + r.name.replace('ROLE_', '') + ']').join(' ');
            return `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.firstName}</td>
                        <td>${user.lastName}</td>
                        <td>${user.age}</td>
                        <td>${user.email}</td>
                        <td>${roles}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">Edit</button>
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteUser(${user.id})">Delete</button>
                        </td>
                    </tr>
                `;
        }).join('');
    }

    function showUsersList() {
        document.getElementById('usersList').style.display = 'block';
        document.getElementById('userForm').style.display = 'none';
        document.querySelectorAll('.nav-link')[0].classList.add('active');
        document.querySelectorAll('.nav-link')[1].classList.remove('active');
        loadUsers();
    }

    function showAddUserForm() {
        document.getElementById('usersList').style.display = 'none';
        document.getElementById('userForm').style.display = 'block';
        document.getElementById('formTitle').textContent = 'Add User';
        document.getElementById('addEditUserForm').reset();
        document.getElementById('userId').value = '';
        document.getElementById('userPassword').required = true;
        document.getElementById('passwordHint').style.display = 'none';
        document.querySelectorAll('.nav-link')[0].classList.remove('active');
        document.querySelectorAll('.nav-link')[1].classList.add('active');
    }

    async function editUser(id) {
        try {
            const response = await fetch(`/api/users/${id}`);
            if (response.ok) {
                const user = await response.json();

                document.getElementById('usersList').style.display = 'none';
                document.getElementById('userForm').style.display = 'block';
                document.getElementById('formTitle').textContent = 'Edit User';

                document.getElementById('userId').value = user.id;
                document.getElementById('firstName').value = user.firstName;
                document.getElementById('lastName').value = user.lastName;
                document.getElementById('age').value = user.age;
                document.getElementById('email').value = user.email;
                document.getElementById('userPassword').value = '';
                document.getElementById('userPassword').required = false;
                document.getElementById('passwordHint').style.display = 'block';

                const adminRole = user.roles.find(r => r.name === 'ROLE_ADMIN');
                document.getElementById('roleName').value = adminRole ? 'ROLE_ADMIN' : 'ROLE_USER';
            }
        } catch (error) {
            showError('Error loading user: ' + error.message);
        }
    }

    document.getElementById('addEditUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const userId = document.getElementById('userId').value;
        const userData = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            age: parseInt(document.getElementById('age').value),
            email: document.getElementById('email').value,
            password: document.getElementById('userPassword').value,
            roleName: document.getElementById('roleName').value
        };

        try {
            let response;
            if (userId) {
                // Update
                response = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + authToken
                    },
                    body: JSON.stringify(userData)
                });
            } else {
                // Create
                response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + authToken
                    },
                    body: JSON.stringify(userData)
                });
            }

            if (response.ok) {
                showSuccess(userId ? 'User updated successfully!' : 'User created successfully!');
                showUsersList();
            } else {
                const error = await response.json();
                showError(error.error || 'Error saving user');
            }
        } catch (error) {
            showError('Error saving user: ' + error.message);
        }
    });

    async function deleteUser(id) {
        if (!confirm('Are you sure you want to delete this user?')) return;

        try {
            const response = await fetch(`/api/users/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Basic ' + authToken
                }
            });

            if (response.ok) {
                showSuccess('User deleted successfully!');
                loadUsers();
            } else {
                showError('Error deleting user');
            }
        } catch (error) {
            showError('Error deleting user: ' + error.message);
        }
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.classList.remove('d-none');
        setTimeout(() => errorDiv.classList.add('d-none'), 5000);
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.classList.remove('d-none');
        setTimeout(() => successDiv.classList.add('d-none'), 3000);
    }

    function logout() {
        localStorage.clear();
        window.location.href = '/login.html';
    }

    loadUsers();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>